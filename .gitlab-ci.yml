image: google/cloud-sdk:alpine
stages:
  - deploy

before_script:
  - export DEF_WORK_DIR=$(pwd)
  - curl -s https://gitlab.com/gitlab-org/incubation-engineering/mobile-devops/download-secure-files/-/raw/main/installer | bash
  - gcloud auth activate-service-account --key-file .secure_files/maximal-radius-375114-f09823b3e627.json

deploy_application:
  stage: deploy
  environment: Production
  only:
    - main
  script:
    - gcloud --quiet --project $PROJECT_ID app deploy app.yaml

deploy_invoicing_function:
  stage: deploy
  environment: Production
  only:
    - main
  script:
    - cd $DEF_WORK_DIR && cd invoicing-function
    - gcloud functions deploy invoicing-function --entry-point $(cat functionMainClass) --region europe-west3 --runtime java17 --trigger-http --memory 512MB --allow-unauthenticated

deploy_bi_function:
  stage: deploy
  environment: Production
  only:
    - main
  script:
    - cd $DEF_WORK_DIR && cd bi-function
    - gcloud functions deploy bi-function --entry-point $(cat functionMainClass) --region europe-west3 --runtime java17 --trigger-http --memory 512MB --allow-unauthenticated

after_script:
- rm -rf .secure_files